<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>服务分析</title>
<link rel="stylesheet" href="css/tong.css">
<style>	
	.content{margin:30px;background-color:#fff;box-shadow:0 0 10px 0 rgba(0,0,0,.2);border-radius:30px;padding:30px;position:relative;}
	
	.biao_tou{line-height:30px;margin:10px 0 25px;}
	.biao_tou>p{float:left;width:calc(100% - 180px);color:#3f3f3f;}
	
	/*二级框样式*/.er_box{border:1px solid #d8e2f0;border-radius:5px;padding:10px;height:100%; box-shadow: 0px 12px 36px 0px rgba(211, 215, 221, 0.4);}
	.er_box>p{color:#404040;font-size:18px;line-height:30px;margin:10px 0 25px;}
	.er_box>div{height:calc(100% - 65px);background-color:rgba(0,0,0,.6);}
	
	/*-- 地图 --*/
	.map_box{width:100%;height:800px;background-color:rgba(0,0,0,.6);}
	/*-- 地图 --*/
	/*-- 提示图标 --*/
	.tishi_biao{position:absolute;bottom:60px;right:60px;background-color:rgba(255,255,255,.6);padding:10px;border-radius:10px;width:600px;}
	.tishi_biao>ul>li{float:left;width:33.3333%;}
	.tishi_biao>ul>li>div{float:left;background:url(img/checheche.png) no-repeat;width:80px;height:60px;background-size:320px 60px;}
	.tishi_biao>ul>li>p{float:left;width:calc(100% - 80px);text-align:center;line-height:60px;font-size:18px;}
	
	.zaixian{background-position:-80px 0!important;}/*在线*/
	.lixian{
		background-position:-80px 0!important;
		-webkit-filter: grayscale(100%); 
		-moz-filter: grayscale(100%); 
		-ms-filter: grayscale(100%); 
		-o-filter: grayscale(100%); 
		filter: grayscale(100%);
	}/*离线*/
	.guzhang{filter:hue-rotate(180deg);background-position:-80px 0!important;}/*故障*/
	.hezuoshe{}/*合作社*/
	.weixiudian{background-position:-160px 0!important;}/*维修点*/
	.jiayouzhan{background-position:-240px 0!important;}/*加油站*/
	/*-- 提示图标 --*/
	
	
	
</style>
</head>

<body>
	<div class="top"><img src="img/biaotou.png" alt=""></div>
	<div class="nav">
		<ul>
			<li>
				<a href="index_no1.html">
					<div class="nav_shhfw"></div>
					<p>社会化服务</p>
				</a>
			</li>
			<li class="jinguo_bg">
				<a href="index_no6.html">
					<div class="nav_fwfx"></div>
					<p>服务分析</p>
				</a>
			</li>
			<li>
				<a href="index_no5.html">
					<div class="nav_sjcs"></div>
					<p>数据传输</p>
				</a>
			</li>
			<li>
				<a href="index_no4.html">
					<div class="nav_zyfx"></div>
					<p>作业分析</p>
				</a>
			</li>
			<li>
				<a href="index_no2.html">
					<div class="nav_xmfx"></div>
					<p>项目分析</p>
				</a>
			</li>
			<li>
				<a href="index_no3.html">
					<div class="nav_zbhzs"></div>
					<p>装备合作社</p>
				</a>
			</li>
			<li>
				<a href="#">
					<div class="nav_jlfx"></div>
					<p>监理分析</p>
				</a>
			</li>
			<h6 class="clearfix"></h6>
		</ul>
	</div>
	<div class="content">
		<div class="map_box">
					<!DOCTYPE html>
		<html lang="zh-CN">
		<head>
			<!-- <base href="//webapi.amap.com/ui/1.0/ui/geo/DistrictCluster/examples/" /> -->
			<meta charset="utf-8">
			<meta http-equiv="X-UA-Compatible" content="IE=edge">
			<meta name="viewport" content="width=device-width, initial-scale=1">
			<title>智慧农机</title>
			<!-- <link href="//a.amap.com/Loca/static/manual/example/style/demo.css" rel="stylesheet"> -->
			<link rel="stylesheet" href="css/demo-center.css"/>
			<style>
				html,
				body,
				#container {
					margin: 0;
					padding: 0;
					width: 100%;
					height: 100%;
				}

				.info-win {
					background: #363F49;
					color: #A0A7B4;
					padding: 10px;
					max-width: 300px;
					min-width: 200px;
					font-size: 12px;
				}

				.info-win tr .content {
					text-align: right;
					color: #D3D8E0;
					max-width: 200px;
				}

				 #loadingTip {
					position: absolute;
					z-index: 9999;
					top: 0;
					left: 0;
					padding: 3px 10px;
					background: red;
					color: #fff;
					font-size: 14px;
				}
			</style>
		</head>
		<body>
		<div id="container" class="container"></div>

		<!-- <div class="input-card">
			<h4>下属行政区查询</h4>
			<div class="input-item">
				<div class="input-item-prepend"><span class="input-item-text" >地级市</span></div>
				<select id='city' style="width:100px" onchange='search(this)'></select>
			</div>
			<div class="input-item">
				<div class="input-item-prepend"><span class="input-item-text" >区县</span></div>
				<select id='district' style="width:100px" onchange='search(this)'></select>
			</div>
			<div class="input-item">
				<div class="input-item-prepend"><span class="input-item-text" >街道</span></div>
				<select id='street' style="width:100px" onchange='setCenter(this)'></select>
			</div>
		</div> -->

		<!--<script src="./script/loca.js"></script>-->
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.10&key=a85256967286f2973a2a29e0cdace9b4"></script> 
		<script src="https://webapi.amap.com/loca?key=a85256967286f2973a2a29e0cdace9b4&v=1.2.0"></script>
		<script src="https://webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.10&key=a85256967286f2973a2a29e0cdace9b4&plugin=AMap.DistrictSearch"></script>
		<!-- <script src="//a.amap.com/Loca/static/manual/example/script/demo.js"></script> -->
		<script src="js/districts.js"></script>
		<script src="js/jquery.min.js"></script>



		<script type="text/javascript">
		var infoWin;
		var tableDom;
		/**
		 * 封装便捷的窗体
		 * @param {AMap.Map} map
		 * @param {Array} event
		 * @param {Object} content
		 */
		function openInfoWin(map, event, content) {
			if (!infoWin) {
				infoWin = new AMap.InfoWindow({
					isCustom: true,  //使用自定义窗体
					offset: new AMap.Pixel(130, 90)
				});
			}

			var x = event.offsetX;
			var y = event.offsetY;
			var lngLat = map.containerToLngLat(new AMap.Pixel(x, y));

			if (!tableDom) {
				let infoDom = document.createElement('div');
				infoDom.className = 'info-win';
				tableDom = document.createElement('table');
				infoDom.appendChild(tableDom);
				infoWin.setContent(infoDom);
			}

			var trStr = '';
			for (var name in content) {
				var val = content[name];
				trStr +=
					'<tr>' +
						'<td class="label">' + name + '</td>' +
						'<td>&nbsp;</td>' +
						'<td class="content">' + val + '</td>' +
					'</tr>'
			}

			tableDom.innerHTML = trStr;
			infoWin.open(map, lngLat);
		}

		function closeInfoWin() {
			if (infoWin) {
				infoWin.close();
			}
		}

		</script>

		<script>

			// var imageLayer = new AMap.ImageLayer({
			//     // url: 'http://amappc.cn-hangzhou.oss-pub.aliyun-inc.com/lbs/static/img/dongwuyuan.jpg',
			//     url: 'http://wdc.goodlinlin.com/AMap/img/b1.jpg',
			//     bounds: new AMap.Bounds(
			//         [112.708241,37.697792],
			//         [113.585192,37.697735]
			//     ),
			//     zooms: [6, 18],
			//     zIndex:150
			// });

			//初始化
			var map = new AMap.Map('container', {
				resizeEnable: true, //是否监控地图容器尺寸变化
				zoom:6, //初始化地图层级
				zooms: [5,18],//设置地图级别范围
				center: [112.549717,37.87046],
				// center: [116.33719, 39.942384], //初始化地图中心点
				layers: [//使用多个图层
					new AMap.TileLayer.Satellite(),
					// new AMap.TileLayer.RoadNet()
					// imageLayer
				],
				// viewMode: '3D',
				// mapStyle: 'amap://styles/macaron',
			});

			//路线和名称标记 显示和隐藏
			var roadNetLayer =  new AMap.TileLayer.RoadNet();
			function addRoadNet(){

				map.add(roadNetLayer);
			}

			function removeRoadNet(){
				map.remove(roadNetLayer);
			}



			//加载Loca可视化图层
			var loca = Loca.create(map);




			//行政区划查询参数
			var district, polygons = [], citycode;
			var citySelect = document.getElementById('city');
			var districtSelect = document.getElementById('district');
			var areaSelect = document.getElementById('street');

			//行政区划查询
			var opts = {
				subdistrict: 1,   //返回下一级行政区
				showbiz:false  //最后一级返回街道信息
			};
			district = new AMap.DistrictSearch(opts);//注意：需要使用插件同步下发功能才能这样直接使用
			district.search('山西省', function(status, result) {
				if(status=='complete'){
					getData(result.districtList[0]);
				}
			});
			function getData(data,level) {
				//清空下一级别的下拉列表
				if (level === 'province') {
					citySelect.innerHTML = '';
					districtSelect.innerHTML = '';
					areaSelect.innerHTML = '';
				} else if (level === 'city') {
					districtSelect.innerHTML = '';
					areaSelect.innerHTML = '';
				} else if (level === 'district') {
					areaSelect.innerHTML = '';
				}

				var bounds = data.boundaries;
				if (bounds) {
					for (var i = 0, l = bounds.length; i < l; i++) {
						var polygon = new AMap.Polygon({
							map: map,
							strokeWeight: 1,
							strokeColor: '#0091ea',
							fillColor: '#80d8ff',
							fillOpacity: 0.2,
							path: bounds[i]
						});
						polygons.push(polygon);
					}
					map.setFitView();//地图自适应
				}


				var subList = data.districtList;
				if (subList) {
					var contentSub = new Option('--请选择--');
					var curlevel = subList[0].level;
					var curList =  document.querySelector('#' + curlevel);
					curList.add(contentSub);
					for (var i = 0, l = subList.length; i < l; i++) {
						var name = subList[i].name;
						var levelSub = subList[i].level;
						var cityCode = subList[i].citycode;
						contentSub = new Option(name);
						contentSub.setAttribute("value", levelSub);
						contentSub.center = subList[i].center;
						contentSub.adcode = subList[i].adcode;
						curList.add(contentSub);
					}
				}

			}
			function search(obj) {
				//清除地图上所有覆盖物
				for (var i = 0, l = polygons.length; i < l; i++) {
					polygons[i].setMap(null);
				}

				//清除下拉框
				if (obj.options.selectedIndex == 0) {
					districtSelect.innerHTML = '';
					areaSelect.innerHTML = '';
				}

				var option = obj[obj.options.selectedIndex];
				var keyword = option.text; //关键字
				var adcode = option.adcode;
				district.setLevel(option.value); //行政区级别
				district.setExtensions('all');
				//行政区查询
				//按照adcode进行查询可以保证数据返回的唯一性
				district.search(adcode, function(status, result) {
					if(status === 'complete'){
						getData(result.districtList[0],obj.id);
					}
				});
			}
			function setCenter(obj){
				map.setCenter(obj[obj.options.selectedIndex].center)
			}





			//加载地图插件-工具栏控制按钮
			// loca.on('mapload', function () {
			//     loca.getMap().plugin(['AMap.ControlBar'], function () {
			//         var controlBar = new AMap.ControlBar();
			//         loca.getMap().addControl(controlBar);
			//     });
			// });


			//区划聚合
			function initPage(DistrictCluster, PointSimplifier, $) {

				var pointSimplifierIns = new PointSimplifier({
					map: map, //所属的地图实例
					autoSetFitView: false, //禁止自动更新地图视野
					zIndex: 110,

					getPosition: function(item) {

						if (!item) {
							return null;
						}

						var parts = item.split(',');

						//返回经纬度
						return [parseFloat(parts[0]), parseFloat(parts[1])];
					},
					getHoverTitle: function(dataItem, idx) {
						return "坐标" + ': ' + dataItem;
					},
					renderOptions: {
						//点的样式
						pointStyle: {
							width: 6,
							height: 6,
							fillStyle:'rgba(153, 0, 153, 0.38)'
						},
						//鼠标hover时的title信息
						hoverTitleStyle: {
							position: 'top'
						}
					}
				});

				var distCluster = new DistrictCluster({
					zIndex: 100,
					map: map, //所属的地图实例
					autoSetFitView: false, //禁止自动更新地图视野
					topAdcodes: [140000],

					getPosition: function(item) {

						if (!item) {
							return null;
						}

						var parts = item.split(',');

						//返回经纬度
						return [parseFloat(parts[0]), parseFloat(parts[1])];
					},
					renderOptions: {
						//基础样式
						featureStyle: {
							fillStyle: 'rgba(102,170,0,0.01)', //填充色
							lineWidth: 2, //描边线宽
							strokeStyle: 'rgb(12,29,69)', //描边色
							//鼠标Hover后的样式
							hoverOptions: {
								fillStyle: 'rgba(255,255,255,0.2)'
							}
						},
						//特定区划级别的默认样式
						featureStyleByLevel: {
							//全国
							country: {
								fillStyle: 'rgba(49, 163, 84, 0.3)'
							},
							//省
							province: {
								fillStyle: 'rgba(116, 196, 118, 0.2)'
							},
							//市
							city: {
								fillStyle: 'rgba(161, 217, 155, 0.1)'
							},
							//区县
							district: {
								fillStyle: 'rgba(199, 233, 192, 0.01)'
							}
						},
						//直接定义某写区划面的样式
						getFeatureStyle: function(feature, dataItems) {

							if (dataItems.length > 30000000) {

								return {
									fillStyle: 'red'
								};

							} else if (dataItems.length > 10000000) {
								return {
									fillStyle: 'orange'
								};
							}

							return {};
						}
					}
				});

				window.distCluster = distCluster;

				function refresh() {

					var zoom = map.getZoom();

					//获取 pointStyle
					var pointStyle = pointSimplifierIns.getRenderOptions().pointStyle;

					//根据当前zoom调整点的尺寸
					pointStyle.width = pointStyle.height = 2 * Math.pow(1.2, map.getZoom() - 3);

					// var zoom = map.getZoom();

					// if (zoom < 10) {

					//     pointSimplifierIns.hide();

					// } else {

					//     pointSimplifierIns.show();
					// }
				}

				map.on('zoomend', function() {
					refresh();
				});

				refresh();

				$('<div id="loadingTip">加载数据，请稍候...</div>').appendTo(document.body);
				$.get('https://a.amap.com/amap-ui/static/data/10w.txt', function(csv) {

					$('#loadingTip').remove();

					var data = csv.split('\n');

					distCluster.setData(data);

					// 使用聚合数据描点
					//pointSimplifierIns.setData(data);
				});
			}

			//加载相关组件
			AMapUI.load(['ui/geo/DistrictCluster', 'ui/misc/PointSimplifier', 'lib/$'], function(DistrictCluster, PointSimplifier, $) {

				//启动页面
				initPage(DistrictCluster, PointSimplifier, $);
			});




			//加载坐标点---终端

			var layer1 = Loca.visualLayer({
				eventSupport: true,    // selectStyle 配置需要开启 eventSupport: true
				container: loca,
				type: 'point',
				shape: 'circle'
			});

			layer1.setOptions({
				style: {
					radius: 4,
					color: '#4fc2ff',
					borderColor: '#ffffff',
					borderWidth: 1.5,
					opacity: 0.8
				},
				selectStyle: {
					radius: 14,
					color: '#ffe30a'
				}
			});

			//提示框
			layer1.on('mousemove', function (ev) {
				// 事件类型
				var type = ev.type;
				// 当前元素的原始数据
				var rawData = ev.rawData;
				// 原始鼠标事件
				var originalEvent = ev.originalEvent;

				openInfoWin(loca.getMap(), originalEvent, {
					'名称': rawData.name,
					'位置': rawData.center
				});
			});

			layer1.on('mouseleave', function (ev) {
				closeInfoWin();
			});


			//添加坐标点数据

			layer1.setData(districts, {
				lnglat: 'center'
			});

			//渲染
			layer1.render();



			//加载坐标点---合作社

			var layer2 = Loca.visualLayer({
				eventSupport: true,    // selectStyle 配置需要开启 eventSupport: true
				container: loca,
				type: 'point',
				shape: 'circle'
			});

			layer2.setOptions({
				style: {
					radius: 4,
					color: '#4fc2ff',
					borderColor: '#ffffff',
					borderWidth: 1.5,
					opacity: 0.8
				},
				selectStyle: {
					radius: 14,
					color: '#ffe30a'
				}
			});

			//提示框
			layer2.on('mousemove', function (ev) {
				// 事件类型
				var type = ev.type;
				// 当前元素的原始数据
				var rawData = ev.rawData;
				// 原始鼠标事件
				var originalEvent = ev.originalEvent;

				openInfoWin(loca.getMap(), originalEvent, {
					'名称': rawData.name,
					'位置': rawData.center
				});
			});

			layer2.on('mouseleave', function (ev) {
				closeInfoWin();
			});


			//添加坐标点数据

			layer2.setData(districts, {
				lnglat: 'center'
			});

			//渲染
			//layer2.render();


			//加载坐标点---加油站

			var layer3 = Loca.visualLayer({
				eventSupport: true,    // selectStyle 配置需要开启 eventSupport: true
				container: loca,
				type: 'point',
				shape: 'circle'
			});

			layer3.setOptions({
				style: {
					radius: 4,
					color: '#4fc2ff',
					borderColor: '#ffffff',
					borderWidth: 1.5,
					opacity: 0.8
				},
				selectStyle: {
					radius: 14,
					color: '#ffe30a'
				}
			});

			//提示框
			layer3.on('mousemove', function (ev) {
				// 事件类型
				var type = ev.type;
				// 当前元素的原始数据
				var rawData = ev.rawData;
				// 原始鼠标事件
				var originalEvent = ev.originalEvent;

				openInfoWin(loca.getMap(), originalEvent, {
					'名称': rawData.name,
					'位置': rawData.center
				});
			});

			layer3.on('mouseleave', function (ev) {
				closeInfoWin();
			});


			//添加坐标点数据

			layer3.setData(districts, {
				lnglat: 'center'
			});

			//渲染
			//layer3.render();


			//加载坐标点---维修点

			var layer4 = Loca.visualLayer({
				eventSupport: true,    // selectStyle 配置需要开启 eventSupport: true
				container: loca,
				type: 'point',
				shape: 'circle'
			});

			layer4.setOptions({
				style: {
					radius: 4,
					color: '#4fc2ff',
					borderColor: '#ffffff',
					borderWidth: 1.5,
					opacity: 0.8
				},
				selectStyle: {
					radius: 14,
					color: '#ffe30a'
				}
			});

			//提示框
			layer4.on('mousemove', function (ev) {
				// 事件类型
				var type = ev.type;
				// 当前元素的原始数据
				var rawData = ev.rawData;
				// 原始鼠标事件
				var originalEvent = ev.originalEvent;

				openInfoWin(loca.getMap(), originalEvent, {
					'名称': rawData.name,
					'位置': rawData.center
				});
			});

			layer4.on('mouseleave', function (ev) {
				closeInfoWin();
			});


			//添加坐标点数据 手册地址 https://lbs.amap.com/api/loca-api/guide/basical/data

			layer4.setData(districts, {
				lnglat: 'center'
			});

			//渲染
			//layer4.render();



			//控制坐标点显示/隐藏
			function addLayer1(){
				layer1.addTo(locaMap);
				layer1.render();
			}

			function removeLayer1(){
				layer1.remove();
			}

			function addLayer2(){
				layer2.addTo(locaMap);
				layer2.render();   
			}

			function removeLayer2(){
				layer2.remove();
			}

			function addLayer3(){
				layer3.addTo(locaMap);
				layer3.render();   
			}

			function removeLayer3(){
				layer3.remove();
			}

			function addLayer4(){
				layer4.addTo(locaMap);
				layer4.render(); 
			}

			function removeLayer4(){
				layer4.remove();
			}


			//单个坐标转换
			 function convertFrom(lnglat, type){
				AMap.convertFrom(lnglat, type, function (status, result) {
				  if (result.info === 'ok') {
					return result.locations[0];
				  }
				});
			}
			//gps转高德
			//convertFrom(lnglat,'gps');

			//多个坐标（）数组转换
			 function convertFrom(path, type){
				AMap.convertFrom(path, type, function (status, result) {
				  if (result.info === 'ok') {
					return result.locations;
				  }
				});
			}
			//gps转高德
			//convertFrom(path,'gps');



			// layer.on('click', function(event) {
			//     console.log('Click target: ', event.target) // 触发click事件的元素
			//     console.log('Event type: ', event.type) // 事件名称
			//     console.log('Raw Event: ', event.originalEvent) // 原始DomEvent事件
			//     console.log('Raw data: ', event.rawData) // 触发元素对应的原始数据
			//     console.log('Lnglat: ', event.lnglat) // 元素所在经纬度
			// });


			//热力图
			// var colors = ['#ecda9a33', '#efc47e66', '#f3ad6a55', '#f7945d44'];

			// $.get('https://a.amap.com/Loca/static/mock/bj_district_wkt.json', function (data) {
			//     var layer1 = Loca.visualLayer({
			//         container: loca,
			//         type: 'polygon',
			//         shape: 'polygon',
			//         fitView: true
			//     });

			//     layer1.setData(data, {
			//         lnglat: 'coordinates'
			//     });

			//     var idx = 0;

			//     layer1.setOptions({
			//         style: {
			//             height: function () {
			//                 return Math.random() * 20000;
			//             },
			//             opacity: 0.9,
			//             color: function () {
			//                 return colors[idx++ % colors.length];
			//             }
			//         }
			//     });

			//     layer1.render();

			// });

		</script>
		</body>
		</html>
		</div>
		<!-- 提示图标 -->
		<div class="tishi_biao">
			<ul>
				<li>
					<div class="zaixian"></div>
					<p>在&emsp;线</p>
					<h6 class="clearfix"></h6>
				</li>
				<li>
					<div class="lixian"></div>
					<p>离&emsp;线</p>
					<h6 class="clearfix"></h6>
				</li>
				<li>
					<div class="guzhang"></div>
					<p>故&emsp;障</p>
					<h6 class="clearfix"></h6>
				</li>
				<li>
					<div class="hezuoshe"></div>
					<p>合作社</p>
					<h6 class="clearfix"></h6>
				</li>
				<li>
					<div class="weixiudian"></div>
					<p>维修点</p>
					<h6 class="clearfix"></h6>
				</li>
				<li>
					<div class="jiayouzhan"></div>
					<p>加油站</p>
					<h6 class="clearfix"></h6>
				</li>
				<h6 class="clearfix"></h6>
			</ul>
		</div>
		<!-- 提示图标 -->
	</div>
</body>
</html>
